From 73a4e68d7f810bda8f400355b4415cd39aa12e34 Mon Sep 17 00:00:00 2001
From: Florian Maurer <f.maurer@outlook.de>
Date: Fri, 3 Oct 2025 22:46:11 +0200
Subject: [PATCH] mt76: add mutex lock around mt7915_mac_twt_teardown_flow

Signed-off-by: Florian Maurer <f.maurer@outlook.de>
---
 ..._lock-around-mt7915_mac_twt_teardown.patch | 30 +++++++++++++++++++
 1 file changed, 30 insertions(+)
 create mode 100644 package/kernel/mt76/patches/0001-mt7915-add-mutex_lock-around-mt7915_mac_twt_teardown.patch

diff --git a/package/kernel/mt76/patches/0001-mt7915-add-mutex_lock-around-mt7915_mac_twt_teardown.patch b/package/kernel/mt76/patches/0001-mt7915-add-mutex_lock-around-mt7915_mac_twt_teardown.patch
new file mode 100644
index 0000000000..d4364682a9
--- /dev/null
+++ b/package/kernel/mt76/patches/0001-mt7915-add-mutex_lock-around-mt7915_mac_twt_teardown.patch
@@ -0,0 +1,30 @@
+From 42c85d03d0b975e2df3d5b0d7e2c9b5cc46968e2 Mon Sep 17 00:00:00 2001
+From: Florian Maurer <f.maurer@outlook.de>
+Date: Fri, 3 Oct 2025 22:39:37 +0200
+Subject: [PATCH] mt7915: add mutex_lock around mt7915_mac_twt_teardown_flow
+
+This adds a lock around mt7915_mac_twt_teardown_flow, which is required as lockdep_assert_held is called within this function
+
+Signed-off-by: Florian Maurer <f.maurer@outlook.de>
+---
+ mt7915/main.c | 2 ++
+ 1 file changed, 2 insertions(+)
+
+diff --git a/mt7915/main.c b/mt7915/main.c
+index 3aa31c5c..aed80e28 100644
+--- a/mt7915/main.c
++++ b/mt7915/main.c
+@@ -850,8 +850,10 @@ int mt7915_mac_sta_event(struct mt76_dev *mdev, struct ieee80211_vif *vif,
+ 		return mt7915_mcu_add_sta(dev, vif, sta, CONN_STATE_PORT_SECURE, false);
+ 
+ 	case MT76_STA_EVENT_DISASSOC:
++		mutex_lock(&dev->mt76.mutex);
+ 		for (i = 0; i < ARRAY_SIZE(msta->twt.flow); i++)
+ 			mt7915_mac_twt_teardown_flow(dev, msta, i);
++		mutex_unlock(&dev->mt76.mutex);
+ 
+ 		mt7915_mcu_add_sta(dev, vif, sta, CONN_STATE_DISCONNECT, false);
+ 		msta->wcid.sta_disabled = 1;
+-- 
+2.47.3
+
-- 
2.47.3

